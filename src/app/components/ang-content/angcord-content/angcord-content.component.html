<div class="h-full w-full bg-discord-lighter flex flex-col">
  <!-- Channel Header -->
  <div class="px-4 py-3 border-b border-discord-border bg-discord-lighter flex-shrink-0 flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <div class="w-6 h-6 bg-discord-blue rounded flex items-center justify-center">
        <span class="text-discord-text-lighter font-bold text-sm">#</span>
      </div>
      <div>
        <h5 class="m-0 text-lg font-semibold text-discord-text-lighter">{{ channel()?.channelName || 'general' }}</h5>
        <p class="m-0 text-sm text-discord-text-muted">{{ getChannelDescription() }}</p>
      </div>
    </div>
    <div class="flex items-center space-x-2">
      <!-- Search Button -->
      <button 
        class="p-2 text-discord-text-muted hover:text-discord-text-light hover:bg-discord-hover rounded transition-colors duration-150 group relative"
        [class.bg-discord-hover]="showSearch"
        [class.text-discord-text-light]="showSearch"
        (click)="openSearch()"
        title="Search in #{{ channel()?.channelName || 'general' }} (Ctrl+F)"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Messages Area -->
  <div class="flex-1 overflow-y-auto pb-2.5 px-4">
    @for (msg of messageList; track msg; let i = $index) {
      <div class="hover:bg-discord-light/30 rounded-lg transition-colors duration-150">
        <div class="flex px-2 py-3 items-start gap-4">
          <div class="flex-shrink-0 w-10 text-center">
            @if (i == 0 || messageList[i-1]?.author?.userId != msg.author.userId) {
              <div class="w-10 h-10 bg-discord-blue rounded-full flex items-center justify-center text-discord-text-lighter font-semibold text-sm">
                {{ msg.author.username?.charAt(0) || 'U' }}
              </div>
            } @else {
              <span class="text-xs text-discord-text-muted-light">{{ msg.postedTimestamp | datetimeFormatter: 'h:mm A' }}</span>
            }
          </div>
          <div class="flex-1 min-w-0">
            <div class="mb-1">
              @if (i == 0 || messageList[i-1]?.author?.userId != msg.author.userId) {
                <span class="text-discord-text-lighter font-medium text-base">{{ msg.author.username }}</span>
                <span class="px-2 text-xs text-discord-text-muted-light">{{ msg.postedTimestamp | datetimeFormatter: 'MM/DD/YYYY h:mm A' }}</span>
              }
            </div>
            <div class="break-words">
              <p class="text-discord-text-light mb-0 text-base leading-relaxed">{{ msg.text }}</p>
            </div>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Message Input Area -->
  <div class="p-4 bg-discord-lighter border-t border-discord-border flex-shrink-0">
    <div class="relative">
      <input 
        type="text" 
        #messageBox 
        id="chatbox" 
        (keydown)="handleKeyDownEvent($event);" 
        (submit)="postMessage(messageBox.value); messageBox.value = '';" 
        [placeholder]="getMessagePlaceholder()"
        class="w-full bg-discord-light text-discord-text-light border-0 rounded-lg px-4 py-3 text-sm focus:bg-discord-light focus:outline-none focus:ring-2 focus:ring-discord-blue/50 transition-all duration-200" 
      />
      <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
        <!-- File Upload Button -->
        <button 
          class="p-1.5 text-discord-text-muted hover:text-discord-text-light hover:bg-discord-hover rounded transition-colors duration-150"
          (click)="uploadFile()"
          title="Upload a file"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
          </svg>
        </button>
        
        <!-- Emoji Button -->
        <button 
          class="p-1.5 text-discord-text-muted hover:text-discord-text-light hover:bg-discord-hover rounded transition-colors duration-150"
          (click)="openEmojiPicker()"
          title="Open emoji picker"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-7.536 5.879a1 1 0 001.415 0 3 3 0 014.242 0 1 1 0 001.415-1.415 5 5 0 00-7.072 0 1 1 0 000 1.415z" clip-rule="evenodd"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Search Component Overlay -->
  @if (showSearch) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="closeSearch()">
      <div class="bg-discord-lighter border border-discord-border rounded-lg shadow-xl w-full max-w-4xl h-[80vh] flex flex-col" (click)="$event.stopPropagation()">
        <app-search
          [serverId]="server()?.serverId || ''"
          [channelId]="(channel()?.channelId || '').toString()"
          [serverName]="server()?.serverName || ''"
          [channelName]="channel()?.channelName || ''"
          (closeSearch)="closeSearch()"
          (messageSelected)="onMessageSelected($event)"
        ></app-search>
      </div>
    </div>
  }

  <!-- Emoji Picker Component -->
  <app-emoji-picker
    [isOpen]="isEmojiPickerOpen()"
    [position]="'top'"
    (emojiSelected)="onEmojiSelected($event)"
    (closed)="onCloseEmojiPicker()"
  ></app-emoji-picker>
</div>
